<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi Siswa</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; display:flex; flex-direction:column; height:100vh; }
header { background:#007bff; display:flex; align-items:center; justify-content:center; padding:15px 20px; color:white; gap:15px; flex-direction:column; text-align:center; flex-shrink:0; }
header img { width:80px; height:80px; object-fit:contain; }
header h1 { margin:5px 0 0 0; font-size:26px; }
header h3 { margin:0; font-size:16px; font-weight:normal; }

#main { display:flex; flex:1; overflow:hidden; }
#sidebar { width:250px; background:#fff; border-right:2px solid #007bff; padding:15px; box-sizing:border-box; overflow-y:auto; }
#sidebar button, #sidebar select { width:100%; margin-bottom:10px; padding:10px; font-size:14px; border-radius:5px; border:1px solid #007bff; background:#007bff; color:white; cursor:pointer; }
#sidebar select { background:white; color:black; border:1px solid #007bff; }
#content { flex:1; padding:20px; overflow:auto; }

#absensi-wrapper { background:white; border-radius:10px; overflow-y:auto; max-height:50%; border:2px solid #007bff; margin-bottom:20px; }
#absensi-table, #rekap-table { width:100%; border-collapse:collapse; margin-bottom:20px; }
#absensi-table th, #absensi-table td, #rekap-table th, #rekap-table td { border:1px solid #ccc; padding:8px; }
#absensi-table th, #rekap-table th { background-color:#007bff; color:white; position:sticky; top:0; z-index:1; text-align:center; }
#absensi-table td, #rekap-table td { text-align:left; }
#absensi-table td:nth-child(1) { text-align:center; } /* Nomor urut */
#absensi-table td:nth-child(2) { text-align:center; } /* NIS */
#absensi-table td:nth-child(4) { text-align:center; } /* Kelas */
#absensi-table td:nth-child(5), #absensi-table td:nth-child(6) { text-align:center; } /* Jam datang/pulang */
#absensi-table td:nth-child(7), #absensi-table td:nth-child(8) { text-align:center; } /* Status/Keterangan */
#rekap-table td:nth-child(1), #rekap-table td { cursor:pointer; }
/* Responsif */
@media(max-width:1000px){
    #main { flex-direction:column; }
    #sidebar { width:100%; border-right:none; border-bottom:2px solid #007bff; }
    #absensi-wrapper { max-height:none; }
}
</style>
</head>
<body>

<header>
    <img src="logo.png" alt="Logo SMPN 20">
    <h1>ABSENSI SISWA</h1>
    <h3>SMPN 20 Konawe Selatan</h3>
</header>

<div id="main">
    <div id="sidebar">
        <button id="btnAll">Semua Siswa</button>
        <select id="filterKelas">
            <option value="">-- Filter Per Kelas --</option>
        </select>
        <select id="filterGuru">
            <option value="">-- Filter Per Guru --</option>
        </select>
        <button id="btnRekap">Tampilkan Rekap</button>
    </div>

    <div id="content">
        <div id="absensi-wrapper">
            <table id="absensi-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>NIS</th>
                        <th>Nama</th>
                        <th>Kelas</th>
                        <th>Jam Datang</th>
                        <th>Jam Pulang</th>
                        <th>Status</th>
                        <th>Keterangan</th>
                    </tr>
                </thead>
                <tbody id="absensi-body"></tbody>
            </table>
        </div>
        <div id="rekap-wrapper">
            <h3>Rekap Absensi (klik untuk filter)</h3>
            <table id="rekap-table">
                <thead>
                    <tr><th>Keterangan</th><th>Jumlah</th></tr>
                </thead>
                <tbody id="rekap-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain: "absensi-smpn-20-konsel.firebaseapp.com",
  projectId: "absensi-smpn-20-konsel",
  storageBucket: "absensi-smpn-20-konsel.appspot.com",
  messagingSenderId: "247838919432",
  appId: "1:247838919432:web:4505c7d499fb5d716dfabd",
  measurementId: "G-1TNJRBYFEV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const absensiBody = document.getElementById("absensi-body");
const rekapBody = document.getElementById("rekap-body");
const filterKelas = document.getElementById("filterKelas");
const filterGuru = document.getElementById("filterGuru");

let allSiswa = [];
let allGuru = [];

// Tanggal hari ini
let today = new Date();
today = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

// Load semua siswa
db.collection("siswa").get().then(snapshot=>{
    const kelasSet = new Set();
    snapshot.forEach(doc=>{
        const s = doc.data();
        allSiswa.push(s);
        kelasSet.add(s.kelas);
    });
    kelasSet.forEach(k=>{
        const opt = document.createElement("option");
        opt.value=k; opt.textContent=k;
        filterKelas.appendChild(opt);
    });
});

// Load guru wali
db.collection("guru_wali").get().then(snapshot=>{
    snapshot.forEach(doc=>{
        const g = doc.data();
        allGuru.push(g);
        const opt = document.createElement("option");
        opt.value=g.nip;
        opt.textContent=g.nama;
        filterGuru.appendChild(opt);
    });
});

// Ambil absensi per hari
function fetchAbsensi(dateStr){
    return db.collection("absensi").doc(dateStr).get().then(doc=>{
        return doc.data() || {};
    });
}

// Filter siswa sesuai kelas & guru
async function applyFilter(){
    let nisSetKelas = null, nisSetGuru = null;

    if(filterKelas.value){
        nisSetKelas = new Set(allSiswa.filter(s=>s.kelas===filterKelas.value).map(s=>s.nis));
    }

    if(filterGuru.value){
        const guru = allGuru.find(g=>String(g.nip)===filterGuru.value);
        nisSetGuru = new Set(guru?.daftarNIS || []);
    }

    let finalNisSet;
    if(nisSetKelas && nisSetGuru){
        finalNisSet = new Set([...nisSetKelas].filter(nis=>nisSetGuru.has(nis)));
    } else if(nisSetKelas){
        finalNisSet = nisSetKelas;
    } else if(nisSetGuru){
        finalNisSet = nisSetGuru;
    } else {
        finalNisSet = new Set(allSiswa.map(s=>s.nis));
    }

    const siswaFiltered = allSiswa.filter(s=>finalNisSet.has(s.nis));
    await updateTable(siswaFiltered);
    updateRekap(siswaFiltered);
    return siswaFiltered;
}

// Update tabel absensi
async function updateTable(data){
    absensiBody.innerHTML="";
    const absensiData = await fetchAbsensi(today);

    data.sort((a,b)=>a.nama.localeCompare(b.nama));
    data.forEach((s, idx)=>{
        const abs = absensiData[s.nis] || {};
        const jamDatang = abs.jamDatang ? new Date(abs.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '-';
        const jamPulang = abs.jamPulang ? new Date(abs.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '-';
        const status = abs.status || '-';
        const keterangan = abs.keterangan || '-';

        const row = document.createElement("tr");
        row.innerHTML = `<td>${idx+1}</td><td>${s.nis}</td><td>${s.nama}</td><td>${s.kelas}</td><td>${jamDatang}</td><td>${jamPulang}</td><td>${status}</td><td>${keterangan}</td>`;
        absensiBody.appendChild(row);
    });
}

// Update rekap
function updateRekap(data){
    rekapBody.innerHTML="";
    const total = data.length;
    const hadir = data.filter(s=>s.status==="Hadir").length;
    const terlambat = data.filter(s=>s.keterangan==="Terlambat").length;
    const perKelas = {};
    const perGuru = {};

    data.forEach(s=>{
        perKelas[s.kelas] = (perKelas[s.kelas]||0)+1;
        const g = allGuru.find(g=>g.daftarNIS?.includes(s.nis));
        const guruNama = g ? g.nama : "Tidak ada";
        perGuru[guruNama] = (perGuru[guruNama]||0)+1;
    });

    const addRow = (ket,jml,filter=null)=>{
        const r = document.createElement("tr");
        r.innerHTML=`<td>${ket}</td><td>${jml}</td>`;
        if(filter) r.onclick=()=>{ filterKelas.value=filter.kelas||""; filterGuru.value=filter.guru||""; applyFilter(); };
        rekapBody.appendChild(r);
    }

    addRow("Total Siswa", total);
    addRow("Hadir", hadir);
    addRow("Terlambat", terlambat);
    Object.keys(perKelas).forEach(k=>addRow("Kelas " + k, perKelas[k], {kelas:k}));
    Object.keys(perGuru).forEach(g=>addRow("Guru " + g, perGuru[g], {guru:g}));
}

// Event listeners
document.getElementById("btnAll").addEventListener("click", ()=>{
    filterKelas.value=""; filterGuru.value="";
    applyFilter();
});
filterKelas.addEventListener("change", applyFilter);
filterGuru.addEventListener("change", applyFilter);
document.getElementById("btnRekap").addEventListener("click", ()=>applyFilter());

// Init
applyFilter();
</script>
</body>
</html>
