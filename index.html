<script>
// Firebase
const db = firebase.firestore();

const absensiBody = document.getElementById("absensi-body");
const rekapBody = document.getElementById("rekap-body");
const filterKelas = document.getElementById("filterKelas");
const filterGuru = document.getElementById("filterGuru");

let allSiswa = [];
let allGuru = [];
let today = new Date();
today = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

// Load semua siswa
db.collection("siswa").get().then(snapshot=>{
    const kelasSet = new Set();
    snapshot.forEach(doc=>{
        const s = doc.data();
        allSiswa.push(s);
        kelasSet.add(s.kelas);
    });
    kelasSet.forEach(k=>{
        const opt = document.createElement("option");
        opt.value=k; opt.textContent=k;
        filterKelas.appendChild(opt);
    });
});

// Load guru wali
db.collection("guru_wali").get().then(snapshot=>{
    snapshot.forEach(doc=>{
        const g = doc.data();
        allGuru.push(g);
        const opt = document.createElement("option");
        opt.value=g.nip;
        opt.textContent=g.nama;
        filterGuru.appendChild(opt);
    });
});

// Ambil absensi per hari
function fetchAbsensi(dateStr){
    return db.collection("absensi").doc(dateStr).get().then(doc=>{
        return doc.data() || {};
    });
}

// Filter siswa sesuai kelas & guru
async function applyFilter(){
    let nisSetKelas = null, nisSetGuru = null;

    if(filterKelas.value){
        nisSetKelas = new Set(allSiswa.filter(s=>s.kelas===filterKelas.value).map(s=>s.nis));
    }

    if(filterGuru.value){
        const guru = allGuru.find(g=>String(g.nip)===filterGuru.value);
        nisSetGuru = new Set(guru?.daftarNIS || []);
    }

    let finalNisSet;
    if(nisSetKelas && nisSetGuru){
        finalNisSet = new Set([...nisSetKelas].filter(nis=>nisSetGuru.has(nis)));
    } else if(nisSetKelas){
        finalNisSet = nisSetKelas;
    } else if(nisSetGuru){
        finalNisSet = nisSetGuru;
    } else {
        finalNisSet = new Set(allSiswa.map(s=>s.nis));
    }

    const siswaFiltered = allSiswa.filter(s=>finalNisSet.has(s.nis));
    updateTable(siswaFiltered);
    updateRekap(siswaFiltered);
    return siswaFiltered;
}

// Update tabel absensi
async function updateTable(data){
    absensiBody.innerHTML="";
    const absensiData = await fetchAbsensi(today);

    data.sort((a,b)=>a.nama.localeCompare(b.nama));
    data.forEach((s, idx)=>{
        const abs = absensiData[s.nis] || {};
        const jamDatang = abs.jamDatang ? new Date(abs.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '-';
        const jamPulang = abs.jamPulang ? new Date(abs.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '-';
        const status = abs.status || '-';
        const keterangan = abs.keterangan || '-';

        const row = document.createElement("tr");
        row.innerHTML = `<td>${idx+1}</td><td>${s.nis}</td><td>${s.nama}</td><td>${s.kelas}</td><td>${jamDatang}</td><td>${jamPulang}</td><td>${status}</td><td>${keterangan}</td>`;
        absensiBody.appendChild(row);
    });
}

// Update rekap
function updateRekap(data){
    rekapBody.innerHTML="";
    const total = data.length;
    const hadir = data.filter(s=>s.status==="Hadir").length;
    const terlambat = data.filter(s=>s.keterangan==="Terlambat").length;
    const perKelas = {};
    const perGuru = {};

    data.forEach(s=>{
        perKelas[s.kelas] = (perKelas[s.kelas]||0)+1;
        const g = allGuru.find(g=>g.daftarNIS?.includes(s.nis));
        const guruNama = g ? g.nama : "Tidak ada";
        perGuru[guruNama] = (perGuru[guruNama]||0)+1;
    });

    const addRow = (ket,jml,filter=null)=>{
        const r = document.createElement("tr");
        r.innerHTML=`<td>${ket}</td><td>${jml}</td>`;
        if(filter) r.onclick=()=>{ filterKelas.value=filter.kelas||""; filterGuru.value=filter.guru||""; applyFilter(); };
        rekapBody.appendChild(r);
    }

    addRow("Total Siswa", total);
    addRow("Hadir", hadir);
    addRow("Terlambat", terlambat);
    Object.keys(perKelas).forEach(k=>addRow("Kelas " + k, perKelas[k], {kelas:k}));
    Object.keys(perGuru).forEach(g=>addRow("Guru " + g, perGuru[g], {guru:g}));
}

// Event listeners
document.getElementById("btnAll").addEventListener("click", ()=>{
    filterKelas.value=""; filterGuru.value="";
    applyFilter();
});
filterKelas.addEventListener("change", applyFilter);
filterGuru.addEventListener("change", applyFilter);

// Inisialisasi
applyFilter();
</script>
