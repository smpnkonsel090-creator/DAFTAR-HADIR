<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi Siswa</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<style>
/* ... gunakan style yang sama seperti sebelumnya ... */
</style>
</head>
<body>
<header>
    <img src="logo.png" alt="Logo SMPN 20">
    <h1>ABSENSI SISWA</h1>
    <h3>SMPN 20 Konawe Selatan</h3>
</header>

<div id="main">
    <div id="sidebar">
        <button id="btnAll">Semua Siswa</button>
        <select id="filterKelas">
            <option value="">-- Filter Per Kelas --</option>
        </select>
        <select id="filterGuru">
            <option value="">-- Filter Per Guru --</option>
        </select>
        <button id="btnRekap">Tampilkan Rekap</button>
    </div>

    <div id="content">
        <div id="absensi-wrapper">
            <table id="absensi-table">
                <thead>
                    <tr>
                        <th>No</th><th>NIS</th><th>Nama</th><th>Kelas</th>
                        <th>Jam Datang</th><th>Jam Pulang</th><th>Status</th><th>Keterangan</th>
                    </tr>
                </thead>
                <tbody id="absensi-body"></tbody>
            </table>
        </div>
        <div id="rekap-wrapper">
            <h3>Rekap Absensi (klik untuk filter)</h3>
            <table id="rekap-table">
                <thead><tr><th>Keterangan</th><th>Jumlah</th></tr></thead>
                <tbody id="rekap-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCAg9Kb4I3dp-fcCIp5RzQKY8mJ3sD4hPU",
  authDomain: "absensi-smpn-20-konsel.firebaseapp.com",
  projectId: "absensi-smpn-20-konsel",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const absensiBody = document.getElementById("absensi-body");
const rekapBody = document.getElementById("rekap-body");
const filterKelas = document.getElementById("filterKelas");
const filterGuru = document.getElementById("filterGuru");

let allSiswa = [];
let allGuru = [];

// Tanggal hari ini
function getToday() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
}

// Load guru
db.collection("guru_wali").get().then(snapshot=>{
    snapshot.forEach(doc=>{
        const data = doc.data();
        allGuru.push({
            nama: data.nama,
            nip: data.nip,
            daftarNIS: (data.daftar_nis||[]).map(nis=>String(nis))
        });
        const opt = document.createElement("option");
        opt.value = data.nip; opt.textContent = data.nama;
        filterGuru.appendChild(opt);
    });
});

// Load absensi hari ini
function loadAbsensi(){
    db.collection("absensi").doc(getToday()).get().then(doc=>{
        const data = doc.data() || {};
        allSiswa = Object.values(data).map(s=>{
            s.nis = String(s.nis);
            return s;
        });

        // Isi dropdown kelas
        const kelasSet = new Set(allSiswa.map(s=>s.kelas));
        filterKelas.innerHTML = '<option value="">-- Filter Per Kelas --</option>';
        kelasSet.forEach(k=>{
            const opt = document.createElement("option");
            opt.value=k; opt.textContent=k;
            filterKelas.appendChild(opt);
        });

        applyFilter(); // tampil semua siswa pertama kali
    });
}
loadAbsensi();

// Update tabel
function updateTable(data){
    absensiBody.innerHTML="";
    data.forEach((s,index)=>{
        const jamDatang = s.jamDatang ? new Date(s.jamDatang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '';
        const jamPulang = s.jamPulang ? new Date(s.jamPulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '';
        const row = document.createElement("tr");
        row.innerHTML = `<td>${index+1}</td><td>${s.nis}</td><td>${s.nama}</td><td>${s.kelas}</td><td>${jamDatang}</td><td>${jamPulang}</td><td>${s.status}</td><td>${s.keterangan||''}</td>`;
        absensiBody.appendChild(row);
    });
}

// Filter
function applyFilter(selectedKelas=null, selectedGuru=null){
    let data = [...allSiswa];

    if(selectedKelas===null) selectedKelas = filterKelas.value;
    if(selectedGuru===null) selectedGuru = filterGuru.value;

    if(selectedKelas) data = data.filter(s=>s.kelas===selectedKelas);
    if(selectedGuru){
        const guru = allGuru.find(g=>String(g.nip)===String(selectedGuru));
        data = data.filter(s=>guru?.daftarNIS?.includes(String(s.nis)));
    }

    updateTable(data);
    return data;
}

// Rekap & klik untuk filter
function updateRekap(){
    const data = applyFilter();
    rekapBody.innerHTML="";
    const total = data.length;
    const hadir = data.filter(s=>s.status==="Hadir").length;
    const perKelas = {};
    const perGuru = {};
    data.forEach(s=>{
        perKelas[s.kelas] = (perKelas[s.kelas]||0)+1;
        const guruObj = allGuru.find(g=>g.daftarNIS?.includes(String(s.nis)));
        const guru = guruObj ? guruObj.nama : "Tidak ada";
        perGuru[guru] = (perGuru[guru]||0)+1;
    });

    const addRow = (ket,jumlah,kelas=null,guruNip=null)=>{
        const r = document.createElement("tr");
        r.innerHTML = `<td>${ket}</td><td>${jumlah}</td>`;
        if(kelas || guruNip){
            r.style.cursor="pointer";
            r.onclick = ()=>{
                filterKelas.value = kelas || "";
                filterGuru.value = guruNip || "";
                applyFilter();
            };
        }
        rekapBody.appendChild(r);
    }

    addRow("Total Siswa", total);
    addRow("Hadir", hadir);
    Object.keys(perKelas).forEach(k=>addRow("Kelas "+k, perKelas[k], k));
    Object.keys(perGuru).forEach(g=>{
        const guruObj = allGuru.find(gr=>gr.nama===g);
        const guruNip = guruObj ? guruObj.nip : null;
        addRow("Guru "+g, perGuru[g], null, guruNip);
    });
}

// Event
document.getElementById("btnAll").addEventListener("click", ()=>{
    filterKelas.value=""; filterGuru.value="";
    updateTable(allSiswa);
});
filterKelas.addEventListener("change", ()=>applyFilter());
filterGuru.addEventListener("change", ()=>applyFilter());
document.getElementById("btnRekap").addEventListener("click", updateRekap);

// Realtime absensi
db.collection("absensi").doc(getToday()).onSnapshot(doc=>{
    const data = doc.data()||{};
    allSiswa = Object.values(data).map(s=>{ s.nis=String(s.nis); return s;});
    applyFilter();
});
</script>
</body>
</html>
